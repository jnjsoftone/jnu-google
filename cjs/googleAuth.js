"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"GoogleAuth",{enumerable:!0,get:function(){return n}});const e=require("@google-cloud/local-auth"),t=require("googleapis"),s=require("jnu-abc");function a(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}const i=({user:e="bigwhitekmc",sn:t=0,scopeDir:a=""}={})=>a?(0,s.loadJson)(`${a}/scopes_${e}_${t}.json`)??(0,s.loadJson)(`${a}/scopes_default.json`):{};class n{async loadSavedCredentialsIfExist(){try{return await t.google.auth.fromJSON(JSON.parse((0,s.loadJson)(this.tokenPath)))}catch(e){return null}}async saveCredentials(e){let t=(0,s.loadJson)(this.crendentialsPath),a=t.installed||t.web,i=JSON.stringify({type:"authorized_user",client_id:a.client_id,client_secret:a.client_secret,expiry_date:e.credentials.expiry_date,refresh_token:e.credentials.refresh_token});(0,s.saveJson)(this.tokenPath,i)}async authorize(){let t=await this.loadSavedCredentialsIfExist();return t?t.credentials.expiry_date&&Date.now()>=t.credentials.expiry_date&&(console.log("Token has expired, refreshing..."),t=await this.refreshAccessToken(t)):(t=await (0,e.authenticate)({scopes:this.scopes,keyfilePath:this.crendentialsPath})).credentials&&await this.saveCredentials(t),t}async refreshAccessToken(e){let{token:t}=await e.getAccessToken();return e.credentials.access_token=t,e.credentials.expiry_date=Date.now()+36e5,await this.saveCredentials(e),e}constructor({user:e="bigwhitekmc",type:t="oauth2",sn:s=0,scopeDir:n="",authDir:r=""}={}){a(this,"tokenPath",""),a(this,"crendentialsPath",""),a(this,"scopes",void 0),this.scopes=i({user:e,sn:s,scopeDir:n}),"oauth2"===t&&(this.tokenPath=`${r}/token_${e}_${s}.json`,this.crendentialsPath=`${r}/${t}_${e}_${s}.json`)}}