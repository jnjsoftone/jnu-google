function e(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}import{authenticate as t}from"@google-cloud/local-auth";import{OAuth2Client as o}from"google-auth-library";import{createClient as s}from"@supabase/supabase-js";let n=s(process.env.SUPABASE_URL,process.env.SUPABASE_ANON_KEY),r=async e=>{try{let{data:t,error:o}=await n.storage.from("google-auth").download(e);if(o)return console.error("Storage read error:",o),null;let s=await t.text();return JSON.parse(s)}catch(e){return console.error("Error loading from storage:",e),null}},a=async(e,t)=>{try{let o=new Blob([JSON.stringify(t)],{type:"application/json"}),{error:s}=await n.storage.from("google-auth").upload(e,o,{upsert:!0});if(s)throw s}catch(e){throw console.error("Error saving to storage:",e),e}},i=async({user:e="bigwhitekmc",sn:t=0,scopeDir:o=""}={})=>{let s=o?await r(`${o}/scopes_${e}_${t}.json`)??await r(`${o}/scopes_default.json`):{};return console.log("Loaded scopes:",s),s};export class GoogleAuth{async init({user:e="bigwhitekmc",sn:t=0,scopeDir:o=""}={}){return this.scopes=await i({user:e,sn:t,scopeDir:o}),this}async loadSavedCredentialsIfExist(){try{console.log("Loading credentials from:",this.tokenPath);let e=await r(this.tokenPath);if(console.log("Loaded credentials:",e?"(exists)":"(not found)"),!e)return console.log("No credentials found"),null;console.log("Loading OAuth2 keys from:",this.crendentialsPath);let t=await r(this.crendentialsPath),s=t.installed||t.web;if(console.log("OAuth2 key loaded:",s?"(exists)":"(not found)"),!s||!s.client_id||!s.client_secret)return console.log("Invalid OAuth2 keys"),null;let n=new o({clientId:s.client_id,clientSecret:s.client_secret,redirectUri:s.redirect_uris[0]}),a={access_token:e.access_token,refresh_token:e.refresh_token,scope:this.scopes.join(" "),token_type:e.token_type||"Bearer",expiry_date:e.expiry_date};console.log("Setting credentials with token:",{hasAccessToken:!!a.access_token,hasRefreshToken:!!a.refresh_token,scope:a.scope,tokenType:a.token_type,expiryDate:a.expiry_date?new Date(a.expiry_date).toISOString():"not set"}),n.setCredentials(a);let i=a.expiry_date;if((!i||Date.now()>=i-3e4)&&a.refresh_token){console.log("Token is expired or about to expire, refreshing...");try{let{credentials:e}=await n.refreshAccessToken();n.setCredentials(e),await this.saveCredentials(n),console.log("Token refreshed successfully")}catch(t){if(console.error("Error refreshing token:",t),!e.refresh_token)return console.log("No refresh token available, authentication required"),null}}return n}catch(e){return console.error("Error loading credentials:",e),null}}async saveCredentials(e){try{console.log("Saving credentials...");let t=await r(this.crendentialsPath),o=t.installed||t.web;if(!e.credentials.refresh_token){console.log("No refresh token in credentials, keeping existing one");let t=await r(this.tokenPath);t?.refresh_token&&(e.credentials.refresh_token=t.refresh_token)}let s={type:"authorized_user",client_id:o.client_id,client_secret:o.client_secret,refresh_token:e.credentials.refresh_token,access_token:e.credentials.access_token,scope:this.scopes.join(" "),token_type:e.credentials.token_type||"Bearer",expiry_date:e.credentials.expiry_date};console.log("Saving credentials to:",this.tokenPath),await a(this.tokenPath,s),console.log("Credentials saved successfully")}catch(e){throw console.error("Error saving credentials:",e),e}}async authorize(){console.log("Starting authorization process...");let e=await this.loadSavedCredentialsIfExist();return e||(console.log("No valid credentials found, starting new authentication..."),(e=await t({scopes:this.scopes,keyfilePath:this.crendentialsPath})).credentials&&(console.log("New authentication successful, saving credentials..."),await this.saveCredentials(e))),e}constructor({user:t="bigwhitekmc",type:o="oauth2",sn:s=0,scopeDir:n="",authDir:r=""}={}){e(this,"tokenPath",""),e(this,"crendentialsPath",""),e(this,"scopes",void 0),console.log("Initializing GoogleAuth with:",{user:t,type:o,sn:s,scopeDir:n,authDir:r}),this.scopes=[],"oauth2"===o&&(this.tokenPath=`${r}/token_${t}_${s}.json`,this.crendentialsPath=`${r}/${o}_${t}_${s}.json`),console.log("Paths:",{tokenPath:this.tokenPath,credentialsPath:this.crendentialsPath})}}